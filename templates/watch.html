<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video.title }} - VideoHub</title>
    <link rel="stylesheet" href="/static/css/youtube.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
    <style>
        .watch-container {
            margin-left: 260px;
            margin-top: 70px;
            width: calc(100% - 260px);
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            padding: 2rem;
        }

        .video-info-box {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .video-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .play-instruction {
            background: rgba(255, 0, 0, 0.1);
            border-left: 4px solid #ff0000;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 2rem;
            color: var(--text-secondary);
        }

        .play-instruction strong {
            color: #ff0000;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .button-group button {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-youtube {
            background: #ff0000;
            color: white;
        }

        .btn-youtube:hover {
            background: #cc0000;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
        }

        .btn-vlc {
            background: #ff9900;
            color: white;
        }

        .btn-vlc:hover {
            background: #ff7700;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.3);
        }

        .video-details {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .video-details h3 {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .detail-value {
            color: var(--text-primary);
            font-weight: 600;
            text-align: right;
        }

        .detail-value a {
            color: #ff0000;
            text-decoration: none;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        @media (max-width: 1024px) {
            .watch-container {
                margin-left: 0;
                width: 100%;
                grid-template-columns: 1fr;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <a href="/" class="logo">
            <i class="fas fa-play-circle"></i>
            <span>VideoHub</span>
        </a>
        <div class="search-bar">
            <input type="text" placeholder="Search videos...">
        </div>
        <div class="header-actions">
            <button class="btn-icon" title="Home" onclick="window.location.href='/'">
                <i class="fas fa-home"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="watch-container">
        <div>
            <!-- Top Ad -->
            <div style="margin-bottom: 2rem; text-align: center;">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
                     data-ad-slot="XXXXXXXXXX"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>

            <!-- Video Player -->
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-bottom: 2rem; aspect-ratio: 16/9;">
                <div id="player" style="width: 100%; height: 100%; display: none;"></div>
                <video id="html5Player" controls preload="metadata" style="width: 100%; height: 100%; display: none;" poster="{% if video.thumbnail_path %}{{ '/' + video.thumbnail_path }}{% else %}{% if video.source_type == 'telegram' %}https://via.placeholder.com/1280x720?text=Telegram+Video{% else %}https://img.youtube.com/vi/{{ video.video_id }}/maxresdefault.jpg{% endif %}{% endif %}">
                    <source id="videoSource" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div id="loadingSpinner" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(255,0,0,0.1), rgba(255,0,0,0.05));">
                    <div style="text-align: center;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #ff0000; margin-bottom: 1rem;"></i>
                        <p style="color: var(--text-secondary); font-size: 1.1rem;">Loading video...</p>
                    </div>
                </div>
            </div>

            <!-- Video Info Box -->
            <div class="video-info-box">
                <div class="video-title">{{ video.title }}</div>

                <div class="play-instruction">
                    <strong>‚ñ∂Ô∏è Video directly website par play ho raha hai!</strong> No YouTube restrictions - full HD quality, fast loading, aur complete control.
                </div>

                <!-- Action Buttons -->
                <div class="button-group">
                    <button class="btn-youtube" onclick="openYouTube()">
                        <i class="fab fa-youtube"></i> Full YouTube
                    </button>
                    <button class="btn-vlc" onclick="openVLC()">
                        <i class="fas fa-video"></i> VLC mein kholen
                    </button>
                    <button class="btn-secondary" onclick="copyVideo('{{ video.video_id }}')" style="background: rgba(0, 123, 255, 0.2); border: 1px solid #007bff; color: #007bff;">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="btn-secondary" onclick="moveVideo('{{ video.video_id }}')" style="background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; color: #ffc107;">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="btn-secondary" onclick="deleteVideo('{{ video.video_id }}')" style="background: rgba(255, 0, 0, 0.2); border: 1px solid #ff0000; color: #ff0000;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    {% if video.source_type == 'telegram' %}
                    <button class="btn-secondary" onclick="moveTelegramVideo('{{ video.video_id }}')" style="background: rgba(0, 204, 136, 0.2); border: 1px solid #00cc88; color: #00cc88;">
                        <i class="fas fa-folder-open"></i> Move to Folder
                    </button>
                    {% endif %}
                </div>

                <!-- Video Controls -->
                <div class="video-controls" style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
                    <label for="speedControl" style="color: var(--text-secondary); font-size: 0.9rem;"><i class="fas fa-tachometer-alt"></i> Speed:</label>
                    <select id="speedControl" onchange="changeSpeed(this.value)" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary);">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x (Normal)</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                    <span style="color: var(--text-secondary); font-size: 0.8rem;">Quality: Auto (Best Available)</span>
                </div>
                    async function moveTelegramVideo(videoId) {
                        const newFolder = prompt('Enter new folder/category name for this Telegram video:');
                        if (!newFolder || !newFolder.trim()) return;
                        try {
                            const formData = new FormData();
                            formData.append('video_id', videoId);
                            formData.append('new_folder', newFolder.trim());
                            const response = await fetch('/api/telegram/move_video', {
                                method: 'POST',
                                body: formData
                            });
                            const data = await response.json();
                            if (response.ok) {
                                showToast('‚úì Telegram video moved to: ' + newFolder, 'success');
                                setTimeout(() => window.location.reload(), 1200);
                            } else {
                                showToast('Error: ' + (data.detail || 'Failed to move video'), 'error');
                            }
                        } catch (error) {
                            showToast('Error: ' + error.message, 'error');
                        }
                    }
            </div>

            <!-- Video Details -->
            <div class="video-details">
                <h3><i class="fas fa-info-circle"></i> Video Information</h3>

                <div class="detail-item">
                    <span class="detail-label"><i class="fas fa-eye"></i> Views</span>
                    <span class="detail-value">{{ video.views_count }}</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label"><i class="fas fa-folder"></i> Folder</span>
                    <span class="detail-value">
                        <a href="/folder/{{ video.folder_name }}">{{ video.folder_name }}</a>
                    </span>
                </div>

                {% if video.get('added_time') %}
                <div class="detail-item">
                    <span class="detail-label"><i class="fas fa-calendar"></i> Added</span>
                    <span class="detail-value">{{ video.added_time[:10] }}</span>
                </div>
                {% endif %}

                <div class="detail-item">
                    <span class="detail-label"><i class="fas fa-link"></i> Source</span>
                    <span class="detail-value">
                        <a href="{{ video.source_url }}" target="_blank">YouTube Link</a>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 4px;
                z-index: 10000;
                font-weight: 600;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                opacity: 0;
                transition: opacity 0.3s;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Fade in
            setTimeout(() => toast.style.opacity = '1', 10);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        const videoId = "{{ video.video_id }}";
        const sourceUrl = "{{ video.source_url }}";
        let player;
        let html5Player = document.getElementById('html5Player');
        let loadingSpinner = document.getElementById('loadingSpinner');

        // Try to load video using direct streaming first
        async function loadVideoStream() {
            try {
                console.log('üîÑ Attempting to load video stream...');
                const response = await fetch(`/api/stream/${videoId}`);
                const data = await response.json();

                if (data.stream_url) {
                    console.log('‚úÖ Direct stream available!');
                    document.getElementById('videoSource').src = data.stream_url;
                    // html5Player.load(); // Don't load automatically
                    html5Player.style.display = 'block';
                    loadingSpinner.style.display = 'none';
                    document.getElementById('player').style.display = 'none';
                    return true;
                } else {
                    console.log('‚ö†Ô∏è Direct stream not available, falling back to YouTube embed');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error loading stream:', error);
                return false;
            }
        }

        // Initialize video player
        async function initializePlayer() {
            const streamLoaded = await loadVideoStream();

            if (!streamLoaded) {
                // Fallback to YouTube embed
                loadingSpinner.style.display = 'none';
                document.getElementById('player').style.display = 'block';

                // Load YouTube IFrame API if not already loaded
                if (typeof YT === 'undefined') {
                    window.onYouTubeIframeAPIReady = function() {
                        player = new YT.Player('player', {
                            height: '100%',
                            width: '100%',
                            videoId: videoId,
                            playerVars: {
                                autoplay: 0,
                                controls: 1,
                                modestbranding: 1,
                                rel: 0,
                                fs: 1,
                                playsinline: 1,
                                iv_load_policy: 3,
                                origin: window.location.origin
                            },
                            events: {
                                'onReady': onPlayerReady,
                                'onError': onPlayerError
                            }
                        });
                    };

                    // Load the YouTube API script
                    const script = document.createElement('script');
                    script.src = 'https://www.youtube.com/iframe_api';
                    document.head.appendChild(script);
                } else {
                    // API already loaded, create player directly
                    player = new YT.Player('player', {
                        height: '100%',
                        width: '100%',
                        videoId: videoId,
                        playerVars: {
                            autoplay: 0,
                            controls: 1,
                            modestbranding: 1,
                            rel: 0,
                            fs: 1,
                            playsinline: 1,
                            iv_load_policy: 3,
                            origin: window.location.origin
                        },
                        events: {
                            'onReady': onPlayerReady,
                            'onError': onPlayerError
                        }
                    });
                }
            }
        }

        function onPlayerReady(event) {
            console.log('‚úÖ YouTube player ready!');
        }

        function onPlayerError(event) {
            console.log('YouTube player error:', event.data);
            if (event.data === 150 || event.data === 151 || event.data === 153) {
                // Embedding not allowed - show fallback
                document.getElementById('player').innerHTML = `
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(255,0,0,0.1), rgba(255,0,0,0.05)); cursor: pointer;" onclick="window.open('${sourceUrl}', '_blank')">
                        <div style="text-align: center;">
                            <i class="fas fa-play-circle" style="font-size: 5rem; color: #ff0000; margin-bottom: 1rem;"></i>
                            <p style="color: white; font-size: 1.1rem; font-weight: 600; margin: 0;">Click to Watch on YouTube</p>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializePlayer();
        });

        function openYouTube() {
            window.open(sourceUrl, '_blank');
        }

        function openVLC() {
            let vlcUrl;
            if ("{{ video.source_type }}" === 'telegram') {
                vlcUrl = 'http://' + window.location.host + sourceUrl;
            } else {
                vlcUrl = 'vlc://' + encodeURIComponent(sourceUrl);
            }
            const msg = 'Opening video in VLC Media Player...';
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: #ff9900;
                color: white;
                padding: 1rem;
                border-radius: 4px;
                z-index: 10000;
                font-weight: 600;
                max-width: 300px;
            `;
            notification.innerHTML = `<i class="fas fa-video"></i> ${msg}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                window.location.href = vlcUrl;
            }, 500);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        async function copyVideo(videoId) {
            const newFolder = prompt('Enter folder path to copy video to (e.g., "Physics" or "Math/Algebra"):');
            if (!newFolder || !newFolder.trim()) return;

            try {
                const formData = new FormData();
                formData.append('video_id', videoId);
                formData.append('new_folder_path', newFolder.trim());

                const response = await fetch('/api/copy_video', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úì Video copied successfully!');
                    // Optionally redirect to the new folder
                    // window.location.href = '/folder/' + encodeURIComponent(newFolder.trim());
                } else {
                    alert('Error: ' + (data.detail || 'Failed to copy video'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error copying video: ' + error.message);
            }
        }

        async function moveVideo(videoId) {
            const newFolder = prompt('Enter folder path to move video to (e.g., "Physics" or "Math/Algebra"):');
            if (!newFolder || !newFolder.trim()) return;

            if (!confirm('Are you sure you want to move this video? It will be removed from the current folder.')) return;

            try {
                const formData = new FormData();
                formData.append('video_id', videoId);
                formData.append('new_folder_path', newFolder.trim());

                const response = await fetch('/api/move_video', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úì Video moved successfully!');
                    window.location.href = '/folder/' + encodeURIComponent(newFolder.trim());
                } else {
                    alert('Error: ' + (data.detail || 'Failed to move video'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error moving video: ' + error.message);
            }
        }

        async function deleteVideo(videoId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete this video?\n\nThis action cannot be undone.')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('video_id', videoId);

                const response = await fetch('/api/delete_video', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úì Video deleted successfully!');
                    window.location.href = '/';
                } else {
                    alert('Error: ' + (data.detail || 'Failed to delete video'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting video: ' + error.message);
            }
        }

        function changeSpeed(speed) {
            const rate = parseFloat(speed);
            if (html5Player && html5Player.style.display !== 'none') {
                html5Player.playbackRate = rate;
                showToast(`Playback speed set to ${speed}x`, 'success');
            } else if (player && typeof player.setPlaybackRate === 'function') {
                player.setPlaybackRate(rate);
                showToast(`Playback speed set to ${speed}x`, 'success');
            } else {
                showToast('Speed control not available for this video', 'error');
            }
        }

        console.log('‚úÖ Watch page loaded for video:', videoId);
    </script>
</body>
</html>
